<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>離線票券管家 (V2.8.2 穩定修復版)</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 引入本地繪製條碼與QR Code的函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- 4. 設定 Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                    },
                    animation: {
                        'pulse-red': 'pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slight': 'bounce-slight 1s infinite',
                    },
                    keyframes: {
                        'pulse-red': {
                            '0%, 100%': { borderColor: 'rgba(220, 38, 38, 0.6)', boxShadow: '0 0 0 0 rgba(220, 38, 38, 0.2)' },
                            '50%': { borderColor: 'rgba(220, 38, 38, 1)', boxShadow: '0 0 15px 4px rgba(220, 38, 38, 0.4)' },
                        },
                        'bounce-slight': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        canvas { max-width: 100%; height: auto; }

        .ticket-card {
            position: relative;
            --card-bg: #ffffff; 
            background: radial-gradient(circle at 0 2.5rem, transparent 0.75rem, var(--card-bg) 0.76rem) top left,
                        radial-gradient(circle at 100% 2.5rem, transparent 0.75rem, var(--card-bg) 0.76rem) top right;
            background-size: 51% 100%;
            background-repeat: no-repeat;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.08));
        }

        .dark .ticket-card {
            --card-bg: #1e293b; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .ticket-divider {
            border-top: 2px dashed #cbd5e1;
            margin: 0.5rem -1rem; 
            position: relative;
            opacity: 0.6;
        }
        .dark .ticket-divider {
            border-color: #475569;
        }
        
        .watermark-used {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 3rem;
            font-weight: 900;
            color: rgba(0,0,0,0.05);
            pointer-events: none;
            border: 4px solid rgba(0,0,0,0.05);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-transform: uppercase;
            z-index: 0;
        }
        .dark .watermark-used {
            color: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-300">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Trash2, Calendar, Check, Plus, LogIn, ExternalLink, Tag, RotateCcw, 
            CheckCircle2, ListTodo, Clock, StickyNote, Save, X, ScanBarcode, 
            Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash, 
            RefreshCcw, Search, FolderPlus, AlertCircle, MoreVertical, Link as LinkIcon,
            Image as ImageIcon, Upload, Clipboard, ClipboardList, AlertTriangle, Download, FileJson, Database, FolderInput,
            LayoutDashboard, Moon, Sun, ChevronUp, ChevronDown, Filter, AlertOctagon, CheckSquare as CheckSquareIcon,
            Bell, BellRing, Send, UserCheck, CloudCog, Maximize2, Wand2, WifiOff, FileUp, Replace, FilePlus2, RefreshCw,
            ImagePlus, Heart, HeartHandshake, Eye, EyeOff, Globe, BookOpen, Star, History, MousePointerClick, Layers,
            Ban // Using Ban instead of CalendarX to avoid crashes
        } from 'lucide-react';

        // --- Helpers ---
        const compressImage = (fileOrUrl) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_WIDTH = 800; 
                    const MAX_HEIGHT = 800;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    try { resolve(canvas.toDataURL('image/jpeg', 0.6)); } catch (e) { reject(new Error("Canvas tainted")); }
                };
                img.onerror = (err) => reject(err);
                if (typeof fileOrUrl === 'string') img.src = fileOrUrl;
                else { const reader = new FileReader(); reader.onload = (e) => { img.src = e.target.result; }; reader.readAsDataURL(fileOrUrl); }
            });
        };

        const getClipboardImage = async () => {
            try {
                if (!navigator.clipboard || !navigator.clipboard.read) { alert("瀏覽器不支援讀取剪貼簿圖片"); return null; }
                const items = await navigator.clipboard.read();
                for (const item of items) {
                    const imageType = item.types.find(type => type.startsWith('image/'));
                    if (imageType) { const blob = await item.getType(imageType); return await compressImage(blob); }
                }
                return null;
            } catch (err) { console.error("Clipboard error:", err); return null; }
        };

        const sendTelegramMessage = async (token, chatId, text) => {
            if (!token || !chatId || !text) return false;
            const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}&parse_mode=Markdown`;
            try { await fetch(url, { mode: 'no-cors' }); return true; } catch (error) { return false; }
        };

        // --- Ticket Parsers ---
        const parseBatchTicketInfo = (text, overrideName, overrideTags, overrideImages) => {
            const results = [];
            const lines = text.split(/\r?\n/);
            let currentNameCandidate = "";
            let currentOrderer = "";
            
            const cleanLine = (l) => l.trim();

            lines.forEach((rawLine, index) => {
                const line = cleanLine(rawLine);
                if (!line) return;

                const ordererMatch = line.match(/(?:訂購人|購買者)[:：\s]*([^,.\s\u0020]+)/i);
                if (ordererMatch && ordererMatch[1]) {
                    currentOrderer = ordererMatch[1].trim();
                }

                let dateStr = "";
                const dateMatch = line.match(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/);
                if (dateMatch) dateStr = dateMatch[0].replace(/[\.\-]/g, '/');
                
                const lineWithoutDate = line.replace(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/, '');
                let serialStr = "";
                const serialMatch = lineWithoutDate.match(/(?:券號|券號：|序號|CODE|Code|密碼|PIN)[:：\s]*([A-Za-z0-9\-\s]{8,})/i);
                
                if (serialMatch && serialMatch[1]) serialStr = serialMatch[1].trim().replace(/\s/g, ''); 
                else {
                    const potentialCodes = lineWithoutDate.match(/[A-Za-z0-9]{9,30}/g);
                    if (potentialCodes) {
                         const validCodes = potentialCodes.filter(code => !/^20\d{6}$/.test(code) && !/^\d{9,15}$/.test(code) && (code.match(/[A-Za-z]/) || code.includes('-')));
                         if (validCodes.length > 0) serialStr = validCodes[0];
                    }
                }
                
                if (serialStr) {
                    let finalName = "未命名票券";
                    if (overrideName && overrideName.trim()) finalName = overrideName.trim();
                    else if (currentNameCandidate) finalName = currentNameCandidate;
                    else if (index > 0 && cleanLine(lines[index-1]).length > 2 && !lines[index-1].includes("期限")) finalName = cleanLine(lines[index-1]);

                    let note = "";
                    if (currentOrderer) { note = `訂購人: ${currentOrderer}`; currentOrderer = ""; }

                    results.push({
                        id: 'task_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2,5),
                        text: rawLine, originalRaw: rawLine, isTicket: true, serial: serialStr, productName: finalName, expiry: dateStr,
                        tags: overrideTags || [], // Multi-tag support
                        images: overrideImages || [], image: (overrideImages && overrideImages.length > 0) ? overrideImages[0] : '',
                        completed: false, isDeleted: false, createdAt: Date.now(), note: note, url: '',
                    });
                    currentNameCandidate = ""; 
                } else if (dateStr && results.length > 0) {
                    const lastResult = results[results.length - 1];
                    if (!lastResult.expiry) lastResult.expiry = dateStr;
                } else {
                    if (line.length > 2 && !line.includes('單價') && !line.includes('說明') && !line.includes('狀態') && !line.includes('期限') && !line.includes('訂購人')) currentNameCandidate = line;
                }
            });

            if (results.length === 0 && text.trim()) {
                const singleResult = parseTicketInfoV1(text);
                let fallbackNote = "";
                const ordererMatch = text.match(/(?:訂購人|購買者)[:：\s]*([^,.\s\u0020]+)/i);
                if (ordererMatch && ordererMatch[1]) fallbackNote = `訂購人: ${ordererMatch[1].trim()}`;

                if (singleResult.isTicket || singleResult.productName !== "未命名票券" || (overrideImages && overrideImages.length > 0)) {
                     results.push({
                        ...singleResult,
                        id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2,9),
                        productName: (overrideName && overrideName.trim()) ? overrideName.trim() : singleResult.productName,
                        tags: overrideTags || [],
                        images: overrideImages || [],
                        image: (overrideImages && overrideImages.length > 0) ? overrideImages[0] : '',
                        completed: false, isDeleted: false, createdAt: Date.now(), note: fallbackNote, url: '',
                     });
                }
            }
            return results;
        };

        const parseTicketInfoV1 = (text) => {
            const result = { isTicket: false, serial: '', productName: '', expiry: '', originalText: text };
            const serialMatch = text.match(/(?:票券序號|序號|CODE|Code|密碼|PIN|券號)[:：\s]*([A-Za-z0-9\-\s]{8,})/i);
            if (serialMatch) { result.isTicket = true; result.serial = serialMatch[1].trim().replace(/\s/g, ''); } 
            else {
                const potentialCodes = text.match(/\b[A-Za-z0-9\-]{9,30}\b/g);
                if (potentialCodes) {
                    const validCodes = potentialCodes.filter(code => code.length > 8 && !code.startsWith('202') && !code.includes('/'));
                    if (validCodes.length > 0) { result.isTicket = true; result.serial = validCodes[0]; }
                }
            }
            const dateMatches = text.match(/(\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2})/g);
            if (dateMatches) result.expiry = dateMatches[dateMatches.length - 1].replace(/[\.\-]/g, '/');
            
            const nameMatch = text.match(/【(.*?)】/);
            if (nameMatch) result.productName = nameMatch[1]; 
            else if (result.isTicket || text.length > 0) {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                result.productName = lines.find(l => l.length > 2 && !l.includes('序號') && !l.includes('期限')) || "未命名票券";
            }
            if (!result.productName) result.productName = "未命名票券";
            return result;
        };

        const checkIsExpiringSoon = (expiryStr, thresholdDays) => {
            if (!expiryStr) return false;
            const diffDays = getDaysRemaining(expiryStr);
            return diffDays <= thresholdDays && diffDays >= 0; 
        };

        const getDaysRemaining = (expiryStr) => {
            if (!expiryStr) return 999;
            const expiryDate = new Date(expiryStr.replace(/[\.\-]/g, '/'));
            if (isNaN(expiryDate.getTime())) return 999;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            return Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        };

        const getTagColorClass = (tag, isDark) => {
            if (!tag || tag === 'default') return isDark ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-600';
            const colors = [
                isDark ? 'bg-orange-900/40 text-orange-200 border-orange-800' : 'bg-orange-50 text-orange-700 border-orange-100',
                isDark ? 'bg-blue-900/40 text-blue-200 border-blue-800' : 'bg-blue-50 text-blue-700 border-blue-100',
                isDark ? 'bg-emerald-900/40 text-emerald-200 border-emerald-800' : 'bg-emerald-50 text-emerald-700 border-emerald-100',
                isDark ? 'bg-purple-900/40 text-purple-200 border-purple-800' : 'bg-purple-50 text-purple-700 border-purple-100',
                isDark ? 'bg-pink-900/40 text-pink-200 border-pink-800' : 'bg-pink-50 text-pink-700 border-pink-100',
                isDark ? 'bg-cyan-900/40 text-cyan-200 border-cyan-800' : 'bg-cyan-50 text-cyan-700 border-cyan-100',
            ];
            let hash = 0;
            for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        const copyToClipboard = async (text) => {
            if (!text) return false;
            try { await navigator.clipboard.writeText(text); return true; } 
            catch (err) {
                const textArea = document.createElement("textarea"); textArea.value = text;
                textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
                const successful = document.execCommand('copy'); document.body.removeChild(textArea); return successful;
            }
        };

        // --- Common Components ---
        const QRCodeCanvas = ({ text, size = 150 }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.QRious) new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'H' }); }, [text, size]);
            return <div className="flex flex-col items-center p-2 bg-white rounded-lg border shadow-sm"><span className="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">QR Code</span><canvas ref={canvasRef} /></div>;
        };

        const BarcodeCanvas = ({ text }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.bwipjs) try { window.bwipjs.toCanvas(canvasRef.current, { bcid: 'code128', text: text, scale: 3, height: 10, includetext: true, textxalign: 'center' }); } catch (e) {} }, [text]);
            return <div className="flex flex-col items-center w-full p-2 bg-white rounded-lg border shadow-sm"><span className="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">Barcode</span><canvas ref={canvasRef} className="max-w-full h-auto" /></div>;
        };
        
        const ImagePreviewModal = ({ src, onClose }) => {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in" onClick={onClose}>
                    <button className="absolute top-4 right-4 text-white p-2 bg-black/50 hover:bg-black/80 rounded-full transition-colors backdrop-blur-md border border-white/20 shadow-lg z-[70]"><X size={32}/></button>
                    <img src={src} className="max-w-full max-h-full object-contain rounded shadow-2xl" onClick={e => e.stopPropagation()}/>
                </div>
            );
        };

        // --- UI Components ---
        
        // ** MultiTagInput for Add/Edit/Batch **
        const MultiTagInput = ({ selectedTags, availableTags, onChange, placeholder = "新增標籤..." }) => {
            const [input, setInput] = useState('');
            const handleAdd = (tag) => { const t = tag.trim(); if (t && !selectedTags.includes(t)) { onChange([...selectedTags, t]); } setInput(''); };
            const handleRemove = (tagToRemove) => { onChange(selectedTags.filter(t => t !== tagToRemove)); };
            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); handleAdd(input); } };

            return (
                <div className="w-full">
                    <div className="flex flex-wrap gap-1 mb-2">
                        {selectedTags.map(tag => (
                            <span key={tag} className="px-2 py-1 rounded-md bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-200 text-sm flex items-center gap-1">
                                {tag} <button onClick={() => handleRemove(tag)} className="hover:text-red-500"><X size={12}/></button>
                            </span>
                        ))}
                    </div>
                    <div className="flex gap-1 relative">
                        <input type="text" list="available-tags-list" value={input} onChange={e => setInput(e.target.value)} onKeyDown={handleKeyDown} placeholder={placeholder} className="flex-1 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg px-3 py-2 text-sm dark:text-white outline-none focus:ring-2 focus:ring-blue-500" />
                        <datalist id="available-tags-list">{availableTags.map(t => <option key={t} value={t} />)}</datalist>
                        <button onClick={() => handleAdd(input)} className="bg-blue-500 text-white px-3 rounded-lg"><Plus size={18}/></button>
                    </div>
                </div>
            );
        };

        // ** QuickAddTagModal **
        const QuickAddTagModal = ({ isOpen, onClose, tags, onAdd }) => {
            const [newTag, setNewTag] = useState('');
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-xl w-full max-w-xs" onClick={e=>e.stopPropagation()}>
                        <h3 className="font-bold mb-3 dark:text-white">新增標籤</h3>
                        <div className="flex gap-2">
                            <input autoFocus list="quick-tag-list" value={newTag} onChange={e=>setNewTag(e.target.value)} className="flex-1 border rounded px-2 py-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="標籤名稱" />
                            <datalist id="quick-tag-list">{tags.map(t=><option key={t} value={t}/>)}</datalist>
                            <button onClick={()=>{ if(newTag.trim()) { onAdd(newTag.trim()); onClose(); } }} className="bg-blue-600 text-white px-3 rounded">OK</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BatchEditPanel = ({ selectedCount, tags, onUpdateName, onUpdateTags, onUpdateImage, onUpdateDate, onClose, gallery, onAddToGallery, onManageTags, onManagePresets, presetNames }) => {
            const [name, setName] = useState('');
            const [expiry, setExpiry] = useState(''); 
            const [batchTags, setBatchTags] = useState([]);
            const [showGallery, setShowGallery] = useState(false);
            const fileInputRef = useRef(null);

            const handleImageUpload = async (e) => {
                if (e.target.files && e.target.files[0]) { try { const img = await compressImage(e.target.files[0]); onUpdateImage([img]); } catch(err) { alert('圖片讀取失敗'); } }
            };
            
            return (
                <div className="fixed bottom-[70px] left-4 right-4 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-600 z-50 animate-in p-4 flex flex-col gap-3">
                    <div className="flex justify-between items-center border-b dark:border-slate-700 pb-2">
                        <h3 className="font-bold text-slate-700 dark:text-white flex items-center gap-2"><Layers size={18} className="text-blue-600"/> 批量編輯 ({selectedCount} 筆)</h3>
                        <button onClick={onClose} className="bg-slate-100 dark:bg-slate-700 rounded-full p-1"><X size={16}/></button>
                    </div>
                    <div className="flex gap-2 items-center">
                        <div className="flex-1 flex gap-1">
                            <input list="preset-names-batch-edit" value={name} onChange={e=>setName(e.target.value)} placeholder="統一修改名稱..." className="flex-1 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg px-2 py-1.5 text-sm dark:text-white"/>
                            <datalist id="preset-names-batch-edit">{presetNames.map(name => <option key={name} value={name} />)}</datalist>
                            <button onClick={onManagePresets} className="px-2 bg-slate-100 dark:bg-slate-700 text-purple-600 rounded-lg"><BookOpen size={16}/></button>
                            <button onClick={()=>name.trim() && onUpdateName(name)} disabled={!name.trim()} className="bg-blue-600 disabled:opacity-50 text-white px-3 rounded-lg text-sm whitespace-nowrap">改名</button>
                        </div>
                    </div>
                    <div className="flex gap-2 items-center">
                        <div className="flex-1 flex gap-1">
                            <input type="date" value={expiry} onChange={e => setExpiry(e.target.value)} className="flex-1 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg px-2 py-1.5 text-sm dark:text-white dark:[color-scheme:dark]"/>
                            <button onClick={() => expiry.trim() && onUpdateDate(expiry)} disabled={!expiry.trim()} className="bg-blue-600 disabled:opacity-50 text-white px-3 rounded-lg text-sm whitespace-nowrap">改期限</button>
                        </div>
                    </div>
                    <div className="border rounded-lg p-2 dark:border-slate-700">
                        <label className="text-xs text-slate-400 mb-1 block">統一設定標籤 (將覆蓋原有標籤)</label>
                        <div className="flex gap-1 items-start">
                            <MultiTagInput selectedTags={batchTags} availableTags={tags} onChange={setBatchTags} placeholder="輸入標籤..." />
                            <button onClick={()=>onUpdateTags(batchTags)} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm whitespace-nowrap mt-1">套用</button>
                        </div>
                    </div>
                    <div className="flex gap-2">
                         <button onClick={()=>fileInputRef.current.click()} className="flex-1 py-1.5 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-lg text-sm flex items-center justify-center gap-1 hover:bg-slate-200 dark:hover:bg-slate-600"><Upload size={14}/> 上傳圖片</button>
                         <button onClick={()=>setShowGallery(true)} className="flex-1 py-1.5 bg-slate-100 dark:bg-slate-700 text-pink-500 rounded-lg text-sm flex items-center justify-center gap-1 hover:bg-slate-200 dark:hover:bg-slate-600"><ImagePlus size={14}/> 圖庫圖片</button>
                    </div>
                    <input type="file" ref={fileInputRef} hidden accept="image/*" onChange={handleImageUpload}/>
                    {showGallery && <GalleryModal isOpen={showGallery} onClose={()=>setShowGallery(false)} images={gallery} onSelect={(img)=>onUpdateImage([img])} onAddImage={onAddToGallery} onDelete={(idx)=> {const newG = [...gallery]; newG.splice(idx,1); onAddToGallery(newG, true);}} />}
                </div>
            );
        };

        const TaskItem = ({ task, tags, onToggle, onDelete, onRestore, onPermanentDelete, onUpdateTicket, isSelectionMode, isSelected, onSelect, expiryThreshold, isDuplicate, isDarkMode, onManageTags, onPreviewImage, gallery, onAddToGallery, presetNames, onManagePresets, onAddTag, onRemoveTag }) => {
            const [showCodes, setShowCodes] = useState(false);
            const [justCopied, setJustCopied] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [showRaw, setShowRaw] = useState(false);
            const [showQuickAdd, setShowQuickAdd] = useState(false);
            
            useEffect(() => { if (isSelectionMode && showCodes) setShowCodes(false); }, [isSelectionMode]);

            const [editName, setEditName] = useState(task.productName || task.text || '');
            const [editSerial, setEditSerial] = useState(task.serial || '');
            const [editExpiry, setEditExpiry] = useState(task.expiry || '');
            const [editCreatedAt, setEditCreatedAt] = useState(''); 
            const [editNote, setEditNote] = useState(task.note || '');
            const [editTags, setEditTags] = useState(task.tags || []);
            const [editImages, setEditImages] = useState(task.images || (task.image ? [task.image] : []));
            const [editMainImage, setEditMainImage] = useState(task.image || '');
            const [showGallery, setShowGallery] = useState(false);
            const [editUrlInput, setEditUrlInput] = useState('');

            useEffect(() => {
                if (isEditing) {
                    const d = task.createdAt ? new Date(task.createdAt) : new Date();
                    const yyyy = d.getFullYear(); const mm = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0');
                    setEditCreatedAt(`${yyyy}-${mm}-${dd}`);
                    setEditImages(task.images || (task.image ? [task.image] : []));
                    setEditMainImage(task.image || '');
                    setEditTags(task.tags || []);
                }
            }, [isEditing, task]);

            const isCompleted = task.completed;
            const isDeleted = task.isDeleted;
            const isExpiring = !isCompleted && !isDeleted && task.expiry && checkIsExpiringSoon(task.expiry, expiryThreshold);
            
            let cardClasses = `ticket-card w-full mb-3 transition-all duration-300 relative overflow-hidden group `;
            if (isDeleted) cardClasses += 'opacity-70 grayscale ';
            if (isSelected) cardClasses += 'ring-2 ring-blue-500 transform scale-[1.01] ';
            if (isDuplicate && !isDeleted) cardClasses += 'border-2 border-red-500 shadow-xl shadow-red-200 dark:shadow-red-900/40 animate-pulse-red z-10 ';
            else if (isExpiring && !isDeleted) cardClasses += 'border border-red-300 shadow-md shadow-red-100 ';

            const getDatePickerValue = (dateStr) => { if(!dateStr) return ''; return dateStr.replace(/\//g, '-').replace(/\./g, '-'); };

            const handleCopy = async (e) => {
                e.stopPropagation();
                if(task.serial && await copyToClipboard(task.serial)) { setJustCopied(true); setTimeout(() => setJustCopied(false), 2000); }
            };

            const handleSaveEdit = () => {
                const formattedExpiry = editExpiry.replace(/-/g, '/');
                let newCreatedAt = task.createdAt;
                if (editCreatedAt) { const d = new Date(editCreatedAt); d.setHours(12,0,0,0); newCreatedAt = d.getTime(); }
                let finalMainImage = editMainImage;
                if (editImages.length > 0 && !editImages.includes(editMainImage)) finalMainImage = editImages[0];
                else if (editImages.length === 0) finalMainImage = '';

                onUpdateTicket(task.id, editName, editSerial, formattedExpiry, finalMainImage, editImages, '', editNote, editTags, newCreatedAt);
                setIsEditing(false);
            };

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if(files.length > 0) {
                    for (const file of files) {
                        try {
                            const compressed = await compressImage(file);
                            setEditImages(prev => [...prev, compressed]);
                            if (!editMainImage) setEditMainImage(compressed);
                        } catch(err) { console.error(err); }
                    }
                }
            };
            
            const handleAddFromGallery = (img) => {
                setEditImages(prev => [...prev, img]);
                if (!editMainImage) setEditMainImage(img);
            };

            const handlePasteImageEdit = async () => {
                const img = await getClipboardImage();
                if (img) { setEditImages(prev => [...prev, img]); if (!editMainImage) setEditMainImage(img); }
            };

            const handleEditUrlImport = async () => {
                if(!editUrlInput) return;
                try {
                    const img = await compressImage(editUrlInput);
                    setEditImages(prev => [...prev, img]);
                    if (!editMainImage) setEditMainImage(img);
                    setEditUrlInput('');
                } catch(e) { window.open(editUrlInput, '_blank'); }
            };

            if (isEditing) {
                return (
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border-2 border-blue-500 p-4 mb-3 space-y-3 relative z-20 animate-in" onClick={e => e.stopPropagation()}>
                        <h3 className="text-sm font-bold text-blue-500 uppercase">編輯票券</h3>
                        <div className="flex gap-2 items-end">
                            <div className="flex-1">
                                <label className="text-xs text-slate-400">品名</label>
                                <input list={`preset-names-edit-${task.id}`} className="w-full bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600 p-1 text-lg font-bold outline-none dark:text-white" value={editName} onChange={e=>setEditName(e.target.value)} placeholder="輸入或選擇..."/>
                                <datalist id={`preset-names-edit-${task.id}`}>{presetNames.map(name => <option key={name} value={name} />)}</datalist>
                            </div>
                            <button onClick={onManagePresets} className="p-2 bg-purple-50 hover:bg-purple-100 text-purple-600 rounded border border-purple-200 mb-1"><BookOpen size={16}/></button>
                        </div>

                        <div>
                             <label className="text-xs text-slate-400">分類標籤</label>
                             <div className="flex gap-1">
                                 <MultiTagInput selectedTags={editTags} availableTags={tags} onChange={setEditTags} />
                                 <button onClick={onManageTags} className="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded border border-blue-200 h-fit" title="管理分類"><FolderPlus size={16}/></button>
                             </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2">
                             <div>
                                <label className="text-xs text-slate-400">有效期限</label>
                                <input type="date" className="w-full bg-slate-50 dark:bg-slate-700 p-2 rounded border border-slate-200 dark:border-slate-600 dark:text-white dark:[color-scheme:dark]" value={getDatePickerValue(editExpiry)} onChange={e=>setEditExpiry(e.target.value)}/>
                             </div>
                             <div>
                                <label className="text-xs text-slate-400">取得日期</label>
                                <input type="date" className="w-full bg-slate-50 dark:bg-slate-700 p-2 rounded border border-slate-200 dark:border-slate-600 dark:text-white dark:[color-scheme:dark]" value={editCreatedAt} onChange={e=>setEditCreatedAt(e.target.value)}/>
                            </div>
                        </div>

                        <div><label className="text-xs text-slate-400">序號</label><input className="w-full font-mono bg-slate-50 dark:bg-slate-700 p-2 rounded border border-slate-200 dark:border-slate-600 dark:text-white" value={editSerial} onChange={e=>setEditSerial(e.target.value)}/></div>
                        <div><label className="text-xs text-slate-400">備註</label><textarea className="w-full bg-slate-50 dark:bg-slate-700 p-2 rounded border border-slate-200 dark:border-slate-600 h-16 resize-none dark:text-white" value={editNote} onChange={e=>setEditNote(e.target.value)}/></div>
                        
                        <div className="flex flex-col gap-2 pt-2 border-t dark:border-slate-700">
                            <label className="text-xs text-slate-400">圖片 (點擊設為封面)</label>
                            {editImages.length > 0 && (
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    {editImages.map((img, idx) => (
                                        <div key={idx} className={`relative flex-shrink-0 w-20 h-20 rounded border-2 overflow-hidden cursor-pointer ${editMainImage === img ? 'border-blue-500 ring-2 ring-blue-200' : 'border-slate-200 dark:border-slate-600'}`} onClick={()=>setEditMainImage(img)}>
                                            <img src={img} className="w-full h-full object-cover"/>
                                            <button onClick={(e)=>{e.stopPropagation(); setEditImages(editImages.filter((_,i)=>i!==idx)); if(editMainImage===img) setEditMainImage(editImages[0]||'');}} className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl"><X size={10}/></button>
                                            {editMainImage === img && <div className="absolute bottom-0 left-0 right-0 bg-blue-500 text-white text-[8px] text-center">封面</div>}
                                        </div>
                                    ))}
                                </div>
                            )}
                            <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                <label className="flex-1 flex items-center justify-center border border-dashed border-slate-300 dark:border-slate-600 rounded p-2 text-slate-400 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors whitespace-nowrap min-w-[80px]">
                                    <Upload size={14} className="mr-1"/> 上傳
                                    <input type="file" hidden accept="image/*" multiple onChange={handleImageUpload}/>
                                </label>
                                <button onClick={handlePasteImageEdit} className="flex-1 flex items-center justify-center border border-dashed border-slate-300 dark:border-slate-600 rounded p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors whitespace-nowrap min-w-[80px]"><ClipboardPaste size={14} className="mr-1"/> 貼上</button>
                                <button onClick={()=>setShowGallery(true)} className="flex-1 flex items-center justify-center border border-dashed border-slate-300 dark:border-slate-600 rounded p-2 text-pink-500 hover:bg-pink-50 dark:hover:bg-slate-700 transition-colors whitespace-nowrap min-w-[80px]"><ImagePlus size={14} className="mr-1"/> 圖庫</button>
                            </div>
                            <div className="flex gap-2">
                                <input type="text" value={editUrlInput} onChange={e=>setEditUrlInput(e.target.value)} placeholder="或輸入圖片網址..." className="flex-1 px-3 py-2 text-sm border rounded-xl bg-slate-50 dark:bg-slate-900 dark:border-slate-700 dark:text-white outline-none"/>
                                <button onClick={handleEditUrlImport} disabled={!editUrlInput} className="px-3 bg-blue-100 text-blue-600 rounded-xl disabled:opacity-50 hover:bg-blue-200 transition-colors"><Globe size={18}/></button>
                            </div>
                        </div>

                        <div className="flex justify-end gap-2 pt-2">
                            <button onClick={()=>setIsEditing(false)} className="px-3 py-1 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded">取消</button>
                            <button onClick={handleSaveEdit} className="px-4 py-1 bg-blue-600 text-white rounded shadow-md hover:bg-blue-700">儲存</button>
                        </div>
                        {showGallery && <GalleryModal isOpen={showGallery} onClose={()=>setShowGallery(false)} images={gallery} onSelect={handleAddFromGallery} onAddImage={onAddToGallery} onDelete={(idx)=> {const newG = [...gallery]; newG.splice(idx,1); onAddToGallery(newG, true);}} />}
                    </div>
                );
            }
            
            const hasMultipleImages = task.images && task.images.length > 1;

            return (
                <div 
                    className={`${cardClasses} cursor-pointer`} 
                    onClick={() => { 
                        if(isSelectionMode) { onSelect(task.id); } 
                        else if(!isDeleted) { setShowCodes(!showCodes); }
                    }}
                >
                    {showRaw && <RawDataModal content={task.originalRaw || task.text || "無原始內容"} onClose={()=>setShowRaw(false)} />}
                    {showQuickAdd && <QuickAddTagModal isOpen={showQuickAdd} onClose={()=>setShowQuickAdd(false)} tags={tags} onAdd={(t)=>onAddTag(task.id, t)} />}
                    
                    <div className="absolute top-0 right-0 z-10 flex flex-col items-end">
                        {isDuplicate && !isDeleted && (
                            <div className="bg-red-600 text-yellow-300 text-xs px-3 py-1 rounded-bl-lg font-black shadow-md mb-[1px] flex items-center gap-1 animate-bounce-slight border-l border-b border-white/20">
                                <AlertOctagon size={12} strokeWidth={3}/> 重複序號
                            </div>
                        )}
                        {isExpiring && !isDuplicate && <div className="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold shadow-sm">即將到期</div>}
                    </div>

                    <div className="pt-4 pb-2 px-3 relative">
                        <div className="flex gap-3">
                            <div className="flex flex-col items-center gap-2 flex-shrink-0">
                                <div onClick={e=>e.stopPropagation()}>
                                    {isSelectionMode ? (
                                        <input type="checkbox" checked={isSelected} onChange={() => onSelect(task.id)} className="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                    ) : (
                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if(!isDeleted) {
                                                    if (isCompleted) onToggle(task);
                                                    else if(confirm(`確認將「${task.productName}」標記為已使用？`)) onToggle(task);
                                                }
                                            }}
                                            disabled={isDeleted} 
                                            className={`px-3 py-1 rounded-full text-xs font-bold shadow-sm border transition-all whitespace-nowrap ${
                                                isDeleted ? 'border-slate-200 text-slate-300 bg-slate-50' : isCompleted ? 'border-green-500 bg-green-500 text-white' : 'border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-100 hover:border-blue-300'
                                            }`}
                                        >
                                            {isCompleted ? '已使用' : '核銷'}
                                        </button>
                                    )}
                                </div>
                                {task.image && (
                                    <div 
                                        className="w-28 h-28 rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden bg-white shadow-sm relative group cursor-pointer"
                                        onClick={(e) => { e.stopPropagation(); onPreviewImage(task.image); }}
                                    >
                                        <img src={task.image} className={`w-full h-full object-cover transition-transform group-hover:scale-110 ${isDeleted && 'grayscale'}`} alt="Ticket" />
                                        <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                            <Maximize2 size={16} className="text-white drop-shadow-md"/>
                                        </div>
                                        {hasMultipleImages && (
                                            <div className="absolute bottom-0 right-0 bg-black/50 text-white text-[10px] px-1 rounded-tl">+{task.images.length-1}</div>
                                        )}
                                    </div>
                                )}
                            </div>

                            <div className="flex-1 min-w-0 flex flex-col justify-start">
                                <div className="flex justify-between items-start gap-1">
                                    <h3 className={`font-bold text-lg leading-snug break-all ${isCompleted || isDeleted ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-800 dark:text-slate-100'}`}>{task.productName}</h3>
                                </div>
                                
                                {/* Tag Section - Interactive */}
                                <div className="flex flex-wrap items-center gap-2 mt-2">
                                    {task.tags && task.tags.map(tag => (
                                        <span 
                                            key={tag} 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if(confirm(`確認移除標籤「${tag}」嗎？`)) onRemoveTag(task.id, tag);
                                            }}
                                            className={`text-[10px] font-bold px-2 py-0.5 rounded border cursor-pointer hover:opacity-70 flex items-center gap-1 ${getTagColorClass(tag, isDarkMode)}`}
                                        >
                                            {tag} <X size={8}/>
                                        </span>
                                    ))}
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); setShowQuickAdd(true); }}
                                        className="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 rounded px-1.5 py-0.5 hover:bg-slate-200 border border-slate-200 dark:border-slate-600"
                                    >
                                        <Plus size={10}/>
                                    </button>

                                    {task.serial && (
                                        <div onClick={handleCopy} className={`flex items-center gap-1 text-sm font-mono px-2 py-0.5 rounded border transition-colors cursor-pointer active:scale-95 ${justCopied ? 'bg-green-100 text-green-700 border-green-200' : 'bg-slate-50 dark:bg-slate-700 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-blue-400'}`}>
                                            {task.serial} {justCopied ? <Check size={12}/> : <CopyIcon size={12} className="opacity-50"/>}
                                        </div>
                                    )}
                                </div>
                                
                                {task.note && <p className="text-xs text-slate-500 dark:text-slate-400 mt-2 bg-slate-50 dark:bg-slate-800/50 p-1.5 rounded line-clamp-3 whitespace-pre-wrap"><StickyNote size={10} className="inline mr-1"/>{task.note}</p>}
                                
                                {hasMultipleImages && (
                                    <div className="flex gap-1 mt-2 overflow-x-auto no-scrollbar" onClick={e=>e.stopPropagation()}>
                                        {task.images.filter(img => img !== task.image).map((img, idx) => (
                                            <img key={idx} src={img} className="w-8 h-8 rounded border border-slate-200 object-cover cursor-pointer hover:opacity-80" onClick={()=>onPreviewImage(img)} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="ticket-divider"></div>

                    <div className="pb-3 px-3 relative">
                        <div className="flex justify-between items-end">
                            <div className="flex flex-col items-start gap-1">
                                <div className="flex flex-col">
                                    <span className="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-0.5 ml-0.5">有效期限</span>
                                    {task.expiry ? (
                                        <span className={`text-sm font-black flex items-center gap-1.5 px-2.5 py-1 rounded-lg border ${
                                            isCompleted || isDeleted ? 'text-slate-400 bg-slate-100 border-slate-200 dark:bg-slate-800 dark:border-slate-700' : isExpiring ? 'text-red-600 bg-red-50 border-red-100 dark:bg-red-900/30 dark:border-red-800' : 'text-green-700 bg-green-50 border-green-100 dark:bg-green-900/30 dark:border-green-800'
                                        }`}>
                                            <Calendar size={14} strokeWidth={2.5}/> {task.expiry}
                                        </span>
                                    ) : (
                                        <span className="text-sm font-bold text-slate-400 dark:text-slate-500 flex items-center gap-1 px-1"><Calendar size={14}/> 無期限</span>
                                    )}
                                </div>
                            </div>

                            <div className="flex flex-col items-end gap-0.5 mr-auto ml-2 opacity-60">
                                <span className="text-[10px] text-slate-400">取得日期</span>
                                <div className="flex items-center gap-1 text-[10px] font-mono text-slate-500 dark:text-slate-400">
                                    <History size={10}/> {task.createdAt ? new Date(task.createdAt).toLocaleDateString() : '-'}
                                </div>
                            </div>

                            <div className="flex flex-col items-end gap-1">
                                <div className="flex gap-1 mb-0.5" onClick={e=>e.stopPropagation()}>
                                    {isDeleted ? (
                                        <>
                                            <button onClick={()=>onRestore(task)} className="p-2 rounded-full hover:bg-green-50 text-green-600"><RefreshCcw size={16}/></button>
                                            <button onClick={()=>onPermanentDelete(task.id)} className="p-2 rounded-full hover:bg-red-50 text-red-500"><Trash2 size={16}/></button>
                                        </>
                                    ) : (
                                        <>
                                            {!isCompleted && !isSelectionMode && <button onClick={()=>{setIsEditing(true);}} className="p-2 rounded-full hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-400 hover:text-blue-500"><Pencil size={16}/></button>}
                                            {!isSelectionMode && <button onClick={()=>onDelete(task.id)} className="p-2 rounded-full hover:bg-red-50 dark:hover:bg-slate-700 text-slate-300 hover:text-red-500"><Trash size={16}/></button>}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {isCompleted && task.completedAt && (
                            <div className="flex justify-end mt-1">
                                <div className="text-[10px] text-slate-400 font-mono bg-slate-50 dark:bg-slate-800/50 px-2 py-0.5 rounded-full flex items-center gap-1">
                                    <CheckCircle2 size={10}/> {new Date(task.completedAt).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})}
                                </div>
                            </div>
                        )}
                    </div>

                    {(isCompleted || isDeleted) && <div className="watermark-used">{isDeleted ? 'DELETED' : 'USED'}</div>}

                    {showCodes && (
                        <div className="border-t border-slate-100 dark:border-slate-700 p-4 bg-slate-50 dark:bg-slate-800/50 animate-in cursor-default text-center relative z-20" onClick={e=>e.stopPropagation()}>
                            <div className="absolute top-2 right-2"><button onClick={()=>setShowCodes(false)} className="p-1 bg-slate-200 dark:bg-slate-700 rounded-full text-slate-500"><X size={16}/></button></div>
                            <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-4">{task.productName}</h4>
                            {task.isTicket && (
                                <div className="space-y-4 flex flex-col items-center">
                                    <div className="bg-white p-2 rounded-lg"><BarcodeCanvas text={task.serial} /></div>
                                    <div className="bg-white p-2 rounded-lg"><QRCodeCanvas text={task.serial} /></div>
                                    <div className="text-2xl font-mono font-bold tracking-widest text-slate-800 dark:text-white select-all">{task.serial}</div>
                                </div>
                            )}
                            {task.note && <div className="mt-4 bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg text-sm text-left text-slate-600 dark:text-slate-300 border border-amber-100 dark:border-amber-800/30 whitespace-pre-wrap">{task.note}</div>}
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ tasks, expiryThreshold }) => {
            const [isOpen, setIsOpen] = useState(true);
            const activeTasks = tasks.filter(t => !t.completed && !t.isDeleted);
            const expiringCount = activeTasks.filter(t => t.expiry && checkIsExpiringSoon(t.expiry, expiryThreshold)).length;
            const completedCount = tasks.filter(t => t.completed && !t.isDeleted).length;

            if(!activeTasks.length && !completedCount) return null;

            return (
                <div className="mb-4 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden">
                    <div className="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4"><LayoutDashboard size={100} /></div>
                    <div className="flex justify-between items-start relative z-10">
                        <div>
                            <h2 className="text-sm font-medium opacity-90 flex items-center gap-1">票券概況 {isOpen ? <ChevronUp size={14} onClick={()=>setIsOpen(false)} className="cursor-pointer"/> : <ChevronDown size={14} onClick={()=>setIsOpen(true)} className="cursor-pointer"/>}</h2>
                            <div className="text-3xl font-bold mt-1">{activeTasks.length} <span className="text-xs font-normal opacity-70">張待使用</span></div>
                        </div>
                        {expiringCount > 0 && (
                            <div className="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-lg flex items-center gap-2 animate-pulse">
                                <AlertTriangle size={16} className="text-yellow-300"/>
                                <span className="font-bold text-sm">{expiringCount} 張快過期</span>
                            </div>
                        )}
                    </div>
                    {isOpen && (
                        <div className="grid grid-cols-3 gap-2 mt-4 relative z-10 border-t border-white/20 pt-3">
                            <div className="text-center"><div className="text-xs opacity-70">今日新增</div><div className="font-bold">{tasks.filter(t=> { const d = t.createdAt ? new Date(t.createdAt) : new Date(); return d.toDateString() === new Date().toDateString() }).length}</div></div>
                            <div className="text-center"><div className="text-xs opacity-70">已完成</div><div className="font-bold">{completedCount}</div></div>
                            <div className="text-center"><div className="text-xs opacity-70">垃圾桶</div><div className="font-bold">{tasks.filter(t=>t.isDeleted).length}</div></div>
                        </div>
                    )}
                </div>
            );
        };

        const BottomNav = ({ view, setView, counts }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 pb-safe pt-2 px-6 flex justify-between items-end z-40 h-[60px] pb-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onClick={() => setView('active')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${view === 'active' ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400'}`}><ListTodo size={24} strokeWidth={view === 'active' ? 2.5 : 2} /><span className="text-[10px] font-medium">待辦</span>{counts.active > 0 && <span className="absolute top-2 ml-6 bg-blue-500 text-white text-[10px] px-1.5 rounded-full min-w-[16px] text-center">{counts.active}</span>}</button>
                <button onClick={() => setView('completed')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${view === 'completed' ? 'text-green-600 dark:text-green-400' : 'text-slate-400'}`}><CheckCircle2 size={24} strokeWidth={view === 'completed' ? 2.5 : 2} /><span className="text-[10px] font-medium">完成</span></button>
                <button onClick={() => setView('deleted')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${view === 'deleted' ? 'text-red-500' : 'text-slate-400'}`}><Trash size={24} strokeWidth={view === 'deleted' ? 2.5 : 2} /><span className="text-[10px] font-medium">回收</span></button>
            </div>
        );

        const AddTaskModal = ({ isOpen, onClose, onAddBatch, tags, onManageTags, gallery, onAddToGallery, presetNames, onManagePresets }) => {
            const [mode, setMode] = useState('paste');
            const [pasteVal, setPasteVal] = useState('');
            const [batchName, setBatchName] = useState('');
            const [batchTags, setBatchTags] = useState([]);
            
            const [manualName, setManualName] = useState('');
            const [manualSerial, setManualSerial] = useState('');
            const [manualExpiry, setManualExpiry] = useState('');
            const [manualCreatedAt, setManualCreatedAt] = useState(''); 
            const [manualNote, setManualNote] = useState('');
            const [manualUrl, setManualUrl] = useState('');
            const [manualTags, setManualTags] = useState([]);
            
            const [pendingImages, setPendingImages] = useState([]);
            const [pendingMainImage, setPendingMainImage] = useState('');
            const [urlInput, setUrlInput] = useState('');
            const [showGallery, setShowGallery] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if(isOpen) {
                    setPasteVal(''); setManualName(''); setManualSerial(''); setManualExpiry(''); setManualNote(''); setManualUrl(''); 
                    setManualTags([]); setBatchTags([]);
                    setPendingImages([]); setPendingMainImage(''); setBatchName('');
                    setMode('paste'); setUrlInput(''); 
                    const today = new Date().toISOString().split('T')[0];
                    setManualCreatedAt(today);
                }
            }, [isOpen]);

            const handleUrlImport = async () => { if(!urlInput) return; try { const img = await compressImage(urlInput); addPendingImage(img); setUrlInput(''); } catch(e) { window.open(urlInput, '_blank'); } };
            const addPendingImage = (img) => { setPendingImages(prev => [...prev, img]); if (!pendingMainImage) setPendingMainImage(img); };
            const removePendingImage = (idx) => { const img = pendingImages[idx]; const newImgs = pendingImages.filter((_,i)=>i!==idx); setPendingImages(newImgs); if(pendingMainImage===img) setPendingMainImage(newImgs[0]||''); };
            const toggleSaveToGallery = (img) => { onAddToGallery(img); alert("已加入圖庫！"); };

            const handleSubmit = () => {
                const results = [];
                const now = Date.now();
                let createdTimestamp = now;
                if (manualCreatedAt) { const d = new Date(manualCreatedAt); const today = new Date(); if (d.toDateString() !== today.toDateString()) { d.setHours(12,0,0,0); createdTimestamp = d.getTime(); } }

                if (mode === 'paste') {
                    const parsedItems = parseBatchTicketInfo(pasteVal, batchName, batchTags, pendingImages);
                    parsedItems.forEach((item, idx) => { results.push({ ...item, createdAt: createdTimestamp }); });
                } else {
                    const fmtExpiry = manualExpiry.replace(/-/g, '/');
                    const finalImages = pendingImages || [];
                    const finalMainImage = pendingMainImage || (finalImages.length > 0 ? finalImages[0] : '');
                    results.push({ 
                        id: 'task_' + now + '_' + Math.random().toString(36).substr(2,9), text: manualName, originalRaw: pasteVal || '', isTicket: (!!manualSerial.trim() || !!finalMainImage), serial: manualSerial.trim(), 
                        productName: manualName, expiry: fmtExpiry, completed: false, isDeleted: false, createdAt: createdTimestamp, note: manualNote, url: manualUrl, tags: manualTags, image: finalMainImage, images: finalImages
                    });
                }
                onAddBatch(results); onClose();
            };

            const handleAnalyzeToManual = () => {
                const parsed = parseTicketInfoV1(pasteVal);
                setManualName(parsed.productName || ''); setManualSerial(parsed.serial || '');
                const dateStr = parsed.expiry ? parsed.expiry.replace(/\//g, '-').replace(/\./g, '-') : '';
                setManualExpiry(dateStr); setMode('manual');
            };

            const handleImage = async (e) => { const files = Array.from(e.target.files); if(files.length > 0) { for (const file of files) { try { const compressed = await compressImage(file); addPendingImage(compressed); } catch(err) {} } } };
            const handlePasteBtn = async () => { const img = await getClipboardImage(); if (img) addPendingImage(img); };
            const handlePaste = async (e) => {
                const text = e.clipboardData.getData('text/plain'); const items = e.clipboardData.items; let imageBlob = null;
                for (let i = 0; i < items.length; i++) { const item = items[i]; if (item.type.indexOf('image') !== -1 || (item.kind === 'file' && item.type.includes('image'))) { imageBlob = item.getAsFile(); break; } }
                if (imageBlob) { e.preventDefault(); try { const compressed = await compressImage(imageBlob); addPendingImage(compressed); } catch (err) {} if (text) setPasteVal(prev => prev + (prev ? '\n' : '') + text); } 
            };

            if(!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center animate-in" onClick={onClose}>
                    <div className="bg-white dark:bg-slate-800 w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-5 max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold dark:text-white">新增票券</h2><button onClick={onClose}><X size={20} className="text-slate-500"/></button></div>
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl mb-4">
                            <button onClick={()=>setMode('paste')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'paste' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300' : 'text-slate-500'}`}>智慧貼上</button>
                            <button onClick={()=>setMode('manual')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'manual' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300' : 'text-slate-500'}`}>手動輸入</button>
                        </div>

                        {mode === 'paste' ? (
                            <div className="space-y-3">
                                <div className="relative">
                                    <textarea value={pasteVal} onChange={e=>setPasteVal(e.target.value)} onPaste={handlePaste} placeholder="在此貼上多筆簡訊..." className="w-full h-40 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none resize-none dark:text-white focus:ring-2 focus:ring-blue-500" autoFocus />
                                </div>
                                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-800">
                                    <h3 className="text-xs font-bold text-blue-600 dark:text-blue-400 mb-2 flex items-center gap-1"><Layers size={12}/> 預設值</h3>
                                    <div className="space-y-2">
                                        <div className="flex gap-2">
                                            <div className="flex-1 flex gap-1">
                                                <input list="preset-names-batch" value={batchName} onChange={e=>setBatchName(e.target.value)} placeholder="指定品名" className="flex-1 px-2 py-1.5 text-sm border rounded-lg bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-white"/>
                                                <datalist id="preset-names-batch">{presetNames.map(name => <option key={name} value={name} />)}</datalist>
                                                <button onClick={onManagePresets} className="px-2 bg-white dark:bg-slate-800 text-purple-600 rounded-lg border border-purple-200"><BookOpen size={16}/></button>
                                            </div>
                                        </div>
                                        <div className="flex gap-1 items-start">
                                            <MultiTagInput selectedTags={batchTags} availableTags={tags} onChange={setBatchTags} placeholder="指定標籤..." />
                                            <button onClick={onManageTags} className="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded border border-blue-200 h-fit" title="管理分類"><FolderPlus size={16}/></button>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleAnalyzeToManual} disabled={!pasteVal.trim()} className="w-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-bold py-2 rounded-lg text-sm flex items-center justify-center gap-2"><ArrowRightLeft size={14}/> 轉手動編輯</button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                <div className="flex gap-2 items-end">
                                    <div className="flex-1">
                                        <input list="preset-names" value={manualName} onChange={e=>setManualName(e.target.value)} placeholder="品名" className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold dark:text-white"/>
                                        <datalist id="preset-names">{presetNames.map(name => <option key={name} value={name} />)}</datalist>
                                    </div>
                                    <button onClick={onManagePresets} className="p-3 bg-purple-50 hover:bg-purple-100 text-purple-600 rounded-xl border border-purple-200"><BookOpen size={18}/></button>
                                </div>
                                <div>
                                     <div className="flex gap-1 items-start">
                                         <MultiTagInput selectedTags={manualTags} availableTags={tags} onChange={setManualTags} />
                                         <button onClick={onManageTags} className="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded border border-blue-200 h-fit" title="管理分類"><FolderPlus size={16}/></button>
                                     </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="flex-1"><label className="text-[10px] text-slate-400 ml-1">有效期限</label><input type="date" value={manualExpiry} onChange={e=>setManualExpiry(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm dark:text-white dark:[color-scheme:dark]"/></div>
                                    <div className="flex-1"><label className="text-[10px] text-slate-400 ml-1">取得日期</label><input type="date" value={manualCreatedAt} onChange={e=>setManualCreatedAt(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm dark:text-white dark:[color-scheme:dark]"/></div>
                                </div>
                                <input value={manualSerial} onChange={e=>setManualSerial(e.target.value)} placeholder="序號" className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm font-mono dark:text-white"/>
                                <textarea value={manualNote} onChange={e=>setManualNote(e.target.value)} placeholder="備註..." className="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm h-20 resize-none dark:text-white"/>
                            </div>
                        )}

                        <div className="mt-4 pt-3 border-t dark:border-slate-700">
                             <div className="flex gap-2 justify-center mb-2 overflow-x-auto no-scrollbar">
                                <button onClick={()=>fileInputRef.current.click()} className="flex items-center gap-1 px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-xl text-slate-600 dark:text-slate-300 text-sm font-medium hover:bg-slate-200 whitespace-nowrap"><ImageIcon size={16}/> 上傳</button>
                                <button onClick={handlePasteBtn} className="flex items-center gap-1 px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-xl text-blue-600 dark:text-blue-300 text-sm font-medium hover:bg-slate-200 whitespace-nowrap"><ClipboardPaste size={16}/> 貼上</button>
                                <button onClick={()=>setShowGallery(true)} className="flex items-center gap-1 px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-xl text-pink-500 text-sm font-medium hover:bg-slate-200 whitespace-nowrap"><ImagePlus size={16}/> 圖庫</button>
                            </div>
                            <div className="flex gap-2 mb-2"><input type="text" value={urlInput} onChange={e=>setUrlInput(e.target.value)} placeholder="或輸入圖片網址..." className="flex-1 px-3 py-2 text-sm border rounded-xl bg-slate-50 dark:bg-slate-900 dark:border-slate-700 dark:text-white outline-none"/><button onClick={handleUrlImport} disabled={!urlInput} className="px-3 bg-blue-100 text-blue-600 rounded-xl disabled:opacity-50 hover:bg-blue-200 transition-colors"><Globe size={18}/></button></div>
                            {pendingImages.length > 0 && (
                                <div className="mt-2 grid grid-cols-3 gap-2 animate-in w-full">
                                    {pendingImages.map((img, idx) => (
                                        <div key={idx} className={`relative border-2 rounded-lg overflow-hidden group h-24 cursor-pointer ${pendingMainImage === img ? 'border-blue-500 ring-2 ring-blue-200' : 'border-slate-200 dark:border-slate-700'}`} onClick={()=>setPendingMainImage(img)}>
                                            <img src={img} className="w-full h-full object-cover bg-slate-100 dark:bg-black/20"/>
                                            <button onClick={(e)=>{e.stopPropagation(); toggleSaveToGallery(img);}} className="absolute bottom-1 right-1 p-1.5 rounded-full shadow-md backdrop-blur-sm bg-white/80 text-pink-500 hover:scale-110 transition-transform z-10"><Heart size={12} fill="currentColor"/></button>
                                            <button onClick={(e)=>{e.stopPropagation(); removePendingImage(idx);}} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-colors z-20"><X size={10}/></button>
                                            {pendingMainImage === img && <div className="absolute top-1 left-1 bg-blue-500 text-white text-[8px] px-1 rounded shadow">封面</div>}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        <input type="file" ref={fileInputRef} hidden accept="image/*" multiple onChange={handleImage} />
                        <button onClick={handleSubmit} disabled={mode==='paste' ? (!pasteVal && pendingImages.length===0) : !manualName} className="w-full mt-6 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 dark:shadow-none flex items-center justify-center gap-2"><Plus size={20}/> {mode === 'paste' ? '批量建立' : '建立票券'}</button>
                        {showGallery && <GalleryModal isOpen={showGallery} onClose={()=>setShowGallery(false)} images={gallery} onSelect={(img)=>{addPendingImage(img);}} onAddImage={onAddToGallery} onDelete={(idx)=> {const newG = [...gallery]; newG.splice(idx,1); onAddToGallery(newG, true);}} />}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

